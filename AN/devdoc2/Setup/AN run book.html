<!doctype html>
<html xmlns:mso="urn:schemas-microsoft-com:office:office" xmlns:msdt="uuid:C2F41010-65B3-11d1-A29F-00AA00C14882">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<style>
h1,
h2,
h3,
h4,
h5,
h6,
p,
blockquote {
    margin: 0;
    padding: 0;
}
body {
    font-family: "Helvetica Neue", Helvetica, "Hiragino Sans GB", Arial, sans-serif;
    font-size: 13px;
    line-height: 18px;
    color: #737373;
    background-color: white;
    margin: 10px 13px 10px 13px;
}
table {
	margin: 10px 0 15px 0;
	border-collapse: collapse;
}
td,th {	
	border: 1px solid #ddd;
	padding: 3px 10px;
}
th {
	padding: 5px 10px;	
}

a {
    color: #0069d6;
}
a:hover {
    color: #0050a3;
    text-decoration: none;
}
a img {
    border: none;
}
p {
    margin-bottom: 9px;
}
h1,
h2,
h3,
h4,
h5,
h6 {
    color: #404040;
    line-height: 36px;
}
h1 {
    margin-bottom: 18px;
    font-size: 30px;
}
h2 {
    font-size: 24px;
}
h3 {
    font-size: 18px;
}
h4 {
    font-size: 16px;
}
h5 {
    font-size: 14px;
}
h6 {
    font-size: 13px;
}
hr {
    margin: 0 0 19px;
    border: 0;
    border-bottom: 1px solid #ccc;
}
blockquote {
    padding: 13px 13px 21px 15px;
    margin-bottom: 18px;
    font-family:georgia,serif;
    font-style: italic;
}
blockquote:before {
    content:"\201C";
    font-size:40px;
    margin-left:-10px;
    font-family:georgia,serif;
    color:#eee;
}
blockquote p {
    font-size: 14px;
    font-weight: 300;
    line-height: 18px;
    margin-bottom: 0;
    font-style: italic;
}
code, pre {
    font-family: Monaco, Andale Mono, Courier New, monospace;
}
code {
    background-color: #fee9cc;
    color: rgba(0, 0, 0, 0.75);
    padding: 1px 3px;
    font-size: 12px;
    -webkit-border-radius: 3px;
    -moz-border-radius: 3px;
    border-radius: 3px;
}
pre {
    display: block;
    padding: 14px;
    margin: 0 0 18px;
    line-height: 16px;
    font-size: 11px;
    border: 1px solid #d9d9d9;
    white-space: pre-wrap;
    word-wrap: break-word;
}
pre code {
    background-color: #fff;
    color:#737373;
    font-size: 11px;
    padding: 0;
}
sup {
    font-size: 0.83em;
    vertical-align: super;
    line-height: 0;
}
* {
	-webkit-print-color-adjust: exact;
}
@media screen and (min-width: 914px) {
    body {
        width: 854px;
        margin:10px auto;
    }
}
@media print {
	body,code,pre code,h1,h2,h3,h4,h5,h6 {
		color: black;
	}
	table, pre {
		page-break-inside: avoid;
	}
}
</style>
<title>AN run book</title>


<!--[if gte mso 9]><xml>
<mso:CustomDocumentProperties>
<mso:Location msdt:dt="string">Development</mso:Location>
<mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_Editor msdt:dt="string">Bailey, Jay (CWE)</mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_Editor>
<mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_Author msdt:dt="string">Bailey, Jay (CWE)</mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_Author>
</mso:CustomDocumentProperties>
</xml><![endif]-->

<!--[if gte mso 9]><xml>
<mso:CustomDocumentProperties>
</mso:CustomDocumentProperties>
</xml><![endif]-->
</head>
<body>
<h2>linux servers list</h2>

<p>Automation INT:</p>

<ul>
<li>anetintapp01.dev.activenetwork.com</li>
<li>anetintapp02.dev.activenetwork.com</li>
<li>int-activenet-05w.an.dev.activenetwork.com</li>
<li>int-activenet-06w.an.dev.activenetwork.com</li>
</ul>


<p>Functional INT:</p>

<ul>
<li>anetintapp03.dev.activenetwork.com</li>
<li>anetintapp04.dev.activenetwork.com</li>
</ul>


<p>Stage:</p>

<ul>
<li>stage-activenet-01w.dev.activenetwork.com</li>
<li>stage-activenet-02w.dev.activenetwork.com</li>
</ul>


<p>Perf:</p>

<ul>
<li>perf-activenet-01w.active.tan ~ perf-activenet-32w.active.tan</li>
</ul>


<p>Prod-US<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>:</p>

<ul>
<li>prod-activenet-01w.an.active.tan ~ prod-activenet-20w.an.active.tan</li>
</ul>


<p>Prod-CA<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup>:</p>

<ul>
<li>TBD</li>
</ul>


<h2>How to login to linux servers</h2>

<p>Unlike windows, linux server doesn't have desktop installed, so they cannot be remote desktop, only way to login is using <a href="https://en.wikipedia.org/wiki/Secure_Shell">SSH</a>.</p>

<h3>from mac or linux</h3>

<ol>
<li>open terminal, login to servers using <code>ssh [username]@[server]</code>, e.g <code>ssh jfang1@anetintapp01.dev.activenetwork.com</code> is to ssh into anetintapp01.dev.activenetwork.com using user jfang1.</li>
<li>all test environment servers can be ssh in using <code>deploy/123!deploy</code>, submit Service-now ticket to request DEV account to login test environment servers, and TAN account for prod environment servers.</li>
<li><a href="https://iam.activenetwork.com/IAM/selfdesk">https://iam.activenetwork.com/IAM/selfdesk</a> to reset DEV/TAN account password</li>
</ol>


<h3>from windows</h3>

<ol>
<li>download <a href="http://www.putty.org/">Putty</a> to login linux using SSH</li>
</ol>


<h2>ActiveNetServlet runtime structure</h2>

<ol>
<li>SSH in a server</li>
<li><code>cd /opt/active/sites</code> - change directory to sites folder where all sites are deployed</li>
<li><code>pwd</code> - is to show current directory</li>
<li><code>ls -l</code> - list all folders in current directory</li>
<li><code>cd jettytest02</code> - change directory to jettytest02</li>
<li><p>org folder structures is fixed:</p>

<pre><code> ├── ActiveNetServlet
 │   ├── config
 │   ├── jetty
 │   ├── lib
 │   ├── logs
 │   └── ui
</code></pre>

<ul>
<li>config contains all configuration files, include sdi.ini and service.properties</li>
<li>jetty contains web resources include html files, jsp files, WEB-INF etc</li>
<li>lib contains all depended jars</li>
<li>logs contains all logs include application log, performance tracer log, gc log<sup id="fnref:3"><a href="#fn:3" rel="footnote">3</a></sup></li>
<li>ui used to be empty</li>
</ul>
</li>
</ol>


<h3>More on runtime structure</h3>

<ol>
<li>SSH into a server</li>
<li><code>cd /opt/active/sites/{org}/ActiveNetServlet</code> - e.g <code>cd /opt/active/sites/jettytest02/ActiveNetServlet</code></li>
<li><p><code>ls -l</code> gives</p>

<pre><code> lrwxrwxrwx 1 deploy root 108 Jan 28 00:17 config -&gt; /opt/active/ActiveNet/dev/jettytest02/V15.40.157/Anetintapp03.dev.activenetwork.com/ActiveNetServlet//config
 lrwxrwxrwx 1 deploy root  65 Jan 28 00:17 jetty -&gt; /opt/active/ActiveNet/dev/share/V15.40.157/ActiveNetServlet/jetty
 lrwxrwxrwx 1 deploy root  63 Jan 28 00:17 lib -&gt; /opt/active/ActiveNet/dev/share/V15.40.157/ActiveNetServlet/lib
 lrwxrwxrwx 1 deploy root 105 Jan 28 00:17 logs -&gt; /opt/active/ActiveNet/dev/jettytest02/V15.40.157/Anetintapp03.dev.activenetwork.com/ActiveNetServlet/logs
</code></pre>

<ul>
<li>it indicates all files are deployed on NFS instead of local drive</li>
<li>/jetty and /lib are shared among servers, i.e applications running in same environment with same version shares web files, and jars. This is to accerlerate deployment</li>
</ul>
</li>
</ol>


<h3>org configurations</h3>

<h4>key settings in service.properties</h4>

<pre><code>appName=ActiveNetServlet-linux01
appVersion=x.x.x
httpPort=8080
jmxPort=9098
memorySize=521m
jvm.memory.permgen=200m
jdk.version=jdk8-1.8.0_31
jvm.memory.bits=64
moreJavaOptions=-Dsite.name=/jettytest02/ -Duser.timezone=PST
jdk.version.target=1.8
jdk.version.source=1.8
jdbc.url=jdbc:sqlserver://WL00070199:1433;DatabaseName=ActiveNetServlet
jdbc.username=recware
jdbc.password=**A6D44CDF5860EEA1
jdbc.initialSize=2
jdbc.minIdle=4
jdbc.maxIdle=8
jdbc.maxTotal=16
logDir=../logs
logLevel=DEBUG
jrs.remote.host=10.119.164.21
jrs.remote.rmiport=1129
</code></pre>

<ul>
<li>appName: the application name, used to be ActiveNetServlet-{orgName}</li>
<li>appVersion: code version populated from ActiveNetSites db, note version.sdi uses different strategy to get version</li>
<li>httpPort: http port</li>
<li>jmxPort: jmx port</li>
<li>memorySize: memorySize=xmx=xms, max/min heap size</li>
<li>jvm.memory.permgen: Maxmetaspace for JDK 1.8+, Permgen for JDK 1.8-</li>
<li>jdk.version: default JDK version to run the application, if given version is not found in default path, it'll start with JAVA_HOME</li>
<li>jvm.memory.bits: jvm bits, fixed as 64</li>
<li>moreJavaOptions: add more java startup options

<ul>
<li>-Dsite.name: is to specify org name in url, this determines the org url patter, e.g -Dsite.name=/jettytest02/ specifies org url to be: http[s]://{host}/jettytest02/servlet/processAdminLogin.sdi</li>
<li>-Duser.timezone: set JDK default timezone, PST for all ANET orgs</li>
</ul>
</li>
<li>jdk.version.target/source: this does not impact runtime jdk version, but just jdk during compilation</li>
<li>jdbc.url: jdbc url for org db</li>
<li>jdbc.*: jdbc/dbcp configurations</li>
<li>logDir: where log files locate</li>
<li>logLevel: could be DEBUG/INFO/WARN/ERROR etc, this only applies to default.log in /config, not for AppLogger</li>
<li>jrs.remote.host/rmiport: JReport server address and rmi port</li>
</ul>


<h4>sdi.ini</h4>

<p>settings in sdi.ini remains same as on windows</p>

<h2>How to start/stop an org</h2>

<ol>
<li><code>cd /opt/active/sites/jettytest02/ActiveNetServlet/config</code> - change directory to config/</li>
<li><code>ls -l</code> - list all files

<ul>
<li>start_service.sh: start script for linux: <code>./start_service.sh</code> to run the script, it'll restart given org if it's already running, otherwise start the org</li>
<li>stop_service.sh: stop script for linux: <code>./stop_service.sh</code> to stop the script, it could take seconds to stop if there're ongoing jobs</li>
<li>start_service.bat: start script for windows, this is mainly for developers windows local</li>
</ul>
</li>
<li>to start the org

<ul>
<li><code>./start_service.sh</code>: it starts given org in the background, this is the normal way to start an org</li>
<li><code>./start_service.sh -f</code>: it starts given org in non-background mode, quit the session would stop the org; the command is useful when there're startup errors are not logged in log files, like insufficient memory errors. Try this one when start_service.sh not able to start the org</li>
</ul>
</li>
<li>to stop the org:

<ul>
<li><code>./stop_service.sh</code>: it stops given org in a gentle way</li>
</ul>
</li>
<li>important note: start/stop org using <code>deploy/123!deploy</code> for non-prod environment, do <code>su deploy</code> before doing this on prod environment, only a few users should have the permission on prod servers</li>
</ol>


<h2>How to view logs</h2>

<p>There're three types of logs generated by application</p>

<ol>
<li>Log in DB generated by AppLogger which remains same as on windows</li>
<li>Log in file generated by AppLogger which remains same as on windows</li>
<li><p>Log in file generated by core-server, log level and location is speicified in service.properties</p>

<ul>
<li>startup and application log: named as ActiveNetServlet-{orgname}{instance}.log, which is also {appName}{appInstance}.log from service.properties, /opt/active/sites/jettytest02/ActiveNetServlet/config/default.log is softlink to actual log file for jettytest02, it creates separate files for each startup, <code>tail -f default.log</code> to view real time log, or use <code>more default.log</code>, or <code>vi default.log</code> to view entire log file, refer to <a href="http://www.linfo.org/vi/search.html">http://www.linfo.org/vi/search.html</a> on how to search key words in log file; to view all log files, go to log dir which is configured in service.properties</li>
<li>GC logs: named as {appName}{appInstance}-gc.log, to view all GC activities, it locates in log dir which is configured in service.properties</li>
<li>Tracer logs: named as {appName}{appInstance}-tracer.log</li>
</ul>
</li>
</ol>


<h2>View server metrics</h2>

<h3>top - similar to task manager on windows</h3>

<ol>
<li>ssh into a server</li>
<li>run <code>top</code> anywhere</li>
<li>press c to show process details</li>
<li>press O in uppercase to sort processes by Time, memory, CPU or else</li>
<li>press 1 to show CPU cores</li>
</ol>


<h4>key metrics in top</h4>

<ol>
<li>load average: cpu load in 1/5/15 mins, e.g 0.3 1 1.2</li>
<li>Mem: memory usage</li>
</ol>


<h3>free</h3>

<ol>
<li>ssh into a server</li>
<li><p>run <code>free</code> anywhere or <code>free -m</code> to show memory in mega byte</p>

<p> [deploy@anetintapp03 ~]$ free -m</p>

<pre><code>      total       used       free     shared    buffers     cached
 Mem: 7872       5631       2240          0        154        978
 -/+ buffers/cache:  4498    3373
 Swap:         1023          0       1023
</code></pre>

<p>from above, 7872M in total, 3373M available</p></li>
</ol>


<h2>Script snippets</h2>

<ul>
<li>start all orgs
<code>
  for n in /opt/active/sites/*/ActiveNetServlet/config; do echo "starting $n..."; cd $n &amp;&amp; ./start_service.sh; done
</code></li>
<li>stop all orgs
<code>
for n in /opt/active/sites/*/ActiveNetServlet/config; do echo "stoping $n..."; cd $n &amp;&amp; ./stop_service.sh; done
</code></li>
<li>get all running org processes
<code>
ps -ef | grep -E -o 'appName=ActiveNetServlet-\w+’ | sort
</code></li>
<li>get all running java processes
<code>
ps -ef | grep -i java
</code></li>
<li>find process for specific org
<code>
ps -ef | grep -i {org name}, e.g ps -ef | grep -i jetytest02
</code></li>
</ul>


<h3>How to setup new server</h3>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>There&rsquo;ll be more servers for the ongoing live sites migration, but all servers follows prod-activenet-[num]w.an.active.tan name convention.<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p>There&rsquo;ll be more servers for the ongoing live sites migration, but all servers follows prod-activenet-[num]w.an.active.tan name convention. <a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
<li id="fn:3">
<p>log dir is configured in service.properties logDir<a href="#fnref:3" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</body>
</html>